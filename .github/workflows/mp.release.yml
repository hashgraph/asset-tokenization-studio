name: Mass Payout Release

on:
  # Manual trigger with preview/release option
  workflow_dispatch:
    inputs:
      release-type:
        description: "Type of release to perform"
        required: true
        type: choice
        options:
          - preview # Show what would be released (dry-run)
          - release # Full production release
        default: "preview"

defaults:
  run:
    shell: bash

permissions:
  contents: write # For creating commits and tags
  id-token: write

jobs:
  mp-release:
    name: Create Mass Payout Release
    runs-on: token-studio-linux-large

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Use GitHub App token to bypass branch protection
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.20.0

      - name: Install dependencies
        run: npm ci

      - name: Validate Mass Payout version
        id: validate
        run: |
          echo "ðŸ“‹ Validating Mass Payout package versions..."

          # Check if there are uncommitted changes (version bump should already be committed)
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "âŒ Uncommitted changes detected. Please commit version changes before running release."
            echo "Uncommitted files:"
            git status --short
            exit 1
          fi

          # Get current Mass Payout version
          MP_VERSION=$(node -p "require('./packages/mass-payout/contracts/package.json').version")
          echo "mp-version=${MP_VERSION}" >> "${GITHUB_OUTPUT}"

          # Check if tag already exists
          TAG_NAME="v${MP_VERSION}-mp"
          if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
            echo "âŒ Tag ${TAG_NAME} already exists. Version bump may not have been performed."
            exit 1
          fi

          echo "âœ… Mass Payout version validated: ${MP_VERSION}"
          echo "âœ… Tag ${TAG_NAME} does not exist yet - ready to release"

      - name: Preview Mass Payout release
        if: ${{ inputs.release-type == 'preview' }}
        run: |
          MP_VERSION="${{ steps.validate.outputs.mp-version }}"
          TAG_NAME="v${MP_VERSION}-mp"

          echo "ðŸ” PREVIEW MODE - What would be released for Mass Payout packages:"
          echo ""
          echo "ðŸ“¦ Mass Payout Version: ${MP_VERSION}"
          echo "ðŸ·ï¸  Tag to create: ${TAG_NAME}"
          echo "ðŸ“‹ GitHub Release: Would be created with auto-generated notes"
          echo ""
          echo "âš ï¸  IMPORTANT: Version bump must be done manually before running release:"
          echo "   1. Run: npx changeset version --ignore '@hashgraph/asset-tokenization-*'"
          echo "   2. Review and commit changes (with GPG signature)"
          echo "   3. Push to remote"
          echo "   4. Run this workflow with 'release' option"
          echo ""
          echo "To proceed with actual release, run this workflow with 'release' option."

      - name: Create Mass Payout release
        id: create-mp-release-tag
        if: ${{ inputs.release-type == 'release' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MP_VERSION="${{ steps.validate.outputs.mp-version }}"
          TAG_NAME="v${MP_VERSION}-mp"
          echo "ðŸ“¦ Creating Mass Payout release tag: ${TAG_NAME}"
          git tag "${TAG_NAME}"
          git push origin "${TAG_NAME}"

          echo "release-tag=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Create github release
        if: ${{ inputs.release-type == 'release' }}
        uses: step-security/release-action@03a57407052f15d1537fd5469a6fbbc536aba326 # v1.20.0
        with:
          tag: ${{ steps.create-mp-release-tag.outputs.release-tag }}
          prerelease: false
          draft: false
          generateReleaseNotes: true
          skipIfReleaseExists: true

      - name: Release Summary
        if: ${{ always() }}
        run: |
          if [ "${{ inputs.release-type }}" = "preview" ]; then
            echo "## ðŸ” Mass Payout Release Preview Completed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Preview mode was selected. No actual release was created." >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**To create the release:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "1. Run \`npx changeset version --ignore '@hashgraph/asset-tokenization-*'\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "2. Review and commit changes with GPG signature: \`git commit -S -m 'chore: release Mass Payout packages'\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "3. Push to remote: \`git push\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "4. Run this workflow again with 'release' option" >> "${GITHUB_STEP_SUMMARY}"
          elif [ "${{ job.status }}" = "success" ]; then
            MP_VERSION="${{ steps.validate.outputs.mp-version }}"
            TAG_NAME="${{ steps.create-mp-release-tag.outputs.release-tag }}"
            echo "## âœ… Mass Payout Release ${TAG_NAME} Completed Successfully" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Component | Status |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| --- | --- |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Version | ${MP_VERSION} |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Tag | ${TAG_NAME} |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| GitHub Release | âœ… Created |" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Next Steps:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- NPM publishing will be triggered automatically via mp.publish.yml" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "## âŒ Mass Payout Release Failed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Check the logs above for details on what went wrong." >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Common issues:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Version bump not committed and pushed before running release" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Tag already exists for current version" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Uncommitted changes in repository" >> "${GITHUB_STEP_SUMMARY}"
          fi
