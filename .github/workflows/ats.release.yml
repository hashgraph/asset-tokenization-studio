name: ATS Release

on:
  # Manual trigger with preview/release option
  workflow_dispatch:
    inputs:
      release-type:
        description: "Type of release to perform"
        required: true
        type: choice
        options:
          - preview # Show what would be released (dry-run)
          - release # Full production release
        default: "preview"

defaults:
  run:
    shell: bash

permissions:
  contents: write # For creating commits and tags
  id-token: write

jobs:
  ats-release:
    name: Create ATS Release
    runs-on: token-studio-linux-large

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Use GitHub App token to bypass branch protection
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: v22.20.0

      - name: Install dependencies
        run: npm ci

      - name: Validate ATS version
        id: validate
        run: |
          echo "ðŸ“‹ Validating ATS package versions..."

          # Check if there are uncommitted changes (version bump should already be committed)
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "âŒ Uncommitted changes detected. Please commit version changes before running release."
            echo "Uncommitted files:"
            git status --short
            exit 1
          fi

          # Get current ATS version
          ATS_VERSION=$(node -p "require('./packages/ats/contracts/package.json').version")
          echo "ats-version=${ATS_VERSION}" >> "${GITHUB_OUTPUT}"

          # Check if tag already exists
          TAG_NAME="v${ATS_VERSION}-ats"
          if git rev-parse "${TAG_NAME}" >/dev/null 2>&1; then
            echo "âŒ Tag ${TAG_NAME} already exists. Version bump may not have been performed."
            exit 1
          fi

          echo "âœ… ATS version validated: ${ATS_VERSION}"
          echo "âœ… Tag ${TAG_NAME} does not exist yet - ready to release"

      - name: Preview ATS release
        if: ${{ inputs.release-type == 'preview' }}
        run: |
          ATS_VERSION="${{ steps.validate.outputs.ats-version }}"
          TAG_NAME="v${ATS_VERSION}-ats"

          echo "ðŸ” PREVIEW MODE - What would be released for ATS packages:"
          echo ""
          echo "ðŸ“¦ ATS Version: ${ATS_VERSION}"
          echo "ðŸ·ï¸  Tag to create: ${TAG_NAME}"
          echo "ðŸ“‹ GitHub Release: Would be created with auto-generated notes"
          echo ""
          echo "âš ï¸  IMPORTANT: Version bump must be done manually before running release:"
          echo "   1. Run: npm run changeset:version (or npx changeset version --ignore @hashgraph/mass-payout-*)"
          echo "   2. Review and commit changes (with GPG signature)"
          echo "   3. Push to remote"
          echo "   4. Run this workflow with 'release' option"
          echo ""
          echo "To proceed with actual release, run this workflow with 'release' option."

      - name: Create ATS release
        id: create-release-tag
        if: ${{ inputs.release-type == 'release' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ATS_VERSION="${{ steps.validate.outputs.ats-version }}"
          TAG_NAME="v${ATS_VERSION}-ats"
          echo "ðŸ“¦ Creating ATS release tag: ${TAG_NAME}"
          git tag "${TAG_NAME}"
          git push origin "${TAG_NAME}"

          echo "tag-name=${TAG_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Create github release
        if: ${{ inputs.release-type == 'release' }}
        uses: step-security/release-action@03a57407052f15d1537fd5469a6fbbc536aba326 # v1.20.0
        with:
          tag: ${{ steps.create-release-tag.outputs.tag-name }}
          prerelease: false
          draft: false
          generateReleaseNotes: true
          skipIfReleaseExists: true

      - name: Release Summary
        if: always()
        run: |
          if [ "${{ inputs.release-type }}" = "preview" ]; then
            echo "## ðŸ” ATS Release Preview Completed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Preview mode was selected. No actual release was created." >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**To create the release:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "1. Run \`npm run changeset:version\` or \`npx changeset version --ignore @hashgraph/mass-payout-*\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "2. Review and commit changes with GPG signature: \`git commit -S -m 'chore: release ATS packages'\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "3. Push to remote: \`git push\`" >> "${GITHUB_STEP_SUMMARY}"
            echo "4. Run this workflow again with 'release' option" >> "${GITHUB_STEP_SUMMARY}"
          elif [ "${{ job.status }}" = "success" ]; then
            ATS_VERSION="${{ steps.validate.outputs.ats-version }}"
            TAG_NAME="${{ steps.create-release-tag.outputs.tag-name }}"
            echo "## âœ… ATS Release ${TAG_NAME} Completed Successfully" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Component | Status |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| --- | --- |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Version | ${ATS_VERSION} |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| Tag | ${TAG_NAME} |" >> "${GITHUB_STEP_SUMMARY}"
            echo "| GitHub Release | âœ… Created |" >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Next Steps:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- NPM publishing will be triggered automatically via ats.publish.yml" >> "${GITHUB_STEP_SUMMARY}"
          else
            echo "## âŒ ATS Release Failed" >> "${GITHUB_STEP_SUMMARY}"
            echo "Check the logs above for details on what went wrong." >> "${GITHUB_STEP_SUMMARY}"
            echo "" >> "${GITHUB_STEP_SUMMARY}"
            echo "**Common issues:**" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Version bump not committed and pushed before running release" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Tag already exists for current version" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Uncommitted changes in repository" >> "${GITHUB_STEP_SUMMARY}"
          fi
