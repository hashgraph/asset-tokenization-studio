name: ATS Publish

on:
  # Manual trigger with dry-run option
  workflow_dispatch:
    inputs:
      dry-run-enabled:
        description: 'Run npm publish with dry-run flag'
        required: false
        type: boolean
        default: false
      ref:
        description: 'Branch/tag/commit to publish from'
        required: false
        type: string
        default: 'main'

  # Release published trigger (GitHub release creation) - only for ATS releases (tags ending with -ats)
  release:
    types:
      - published

defaults:
  run:
    shell: bash

permissions:
  contents: read
  id-token: write

jobs:
  contracts:
    name: Publish ATS Contracts
    runs-on: token-studio-linux-large
    # Only run if manual trigger OR release tag contains 'ats'/'ATS'
    if: github.event_name == 'workflow_dispatch' || contains(github.ref_name, 'ats') || contains(github.ref_name, 'ATS')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org

      - name: Create .npmrc file
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cat << 'EOF' > .npmrc
          //registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}
          EOF

      - name: Install dependencies
        run: npm ci

      - name: Build ATS Contracts
        run: npm run ats:contracts:build

      - name: Publish ATS Contracts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ inputs.dry-run-enabled }}
        run: |
          echo "DRY_RUN is set to: '${DRY_RUN}'"

          cd packages/ats/contracts

          PUBLISH_ARGS=("--access=restricted")
          if [[ "${DRY_RUN}" == "true" ]]; then
            PUBLISH_ARGS+=("--dry-run")
            echo "üîç DRY RUN MODE: Would publish @hashgraph/asset-tokenization-contracts"
          fi

          npm publish "${PUBLISH_ARGS[@]}"

  sdk:
    name: Publish ATS SDK
    runs-on: token-studio-linux-large
    # Only run if manual trigger OR release tag contains 'ats'/'ATS'
    if: github.event_name == 'workflow_dispatch' || contains(github.ref_name, 'ats') || contains(github.ref_name, 'ATS')
    # needs: contracts  # Commented out for parallel execution
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0 # v2.12.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Setup NodeJS Environment
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22.x
          registry-url: https://registry.npmjs.org

      - name: Create .npmrc file
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cat << 'EOF' > .npmrc
          //registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}
          EOF

      - name: Install dependencies
        run: npm ci

      - name: Build ATS Contracts and SDK
        run: |
          npm run ats:contracts:build
          npm run ats:sdk:build

      - name: Publish ATS SDK
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          DRY_RUN: ${{ inputs.dry-run-enabled }}
        run: |
          echo "DRY_RUN is set to: '${DRY_RUN}'"

          cd packages/ats/sdk

          PUBLISH_ARGS=("--access=restricted")
          if [[ "${DRY_RUN}" == "true" ]]; then
            PUBLISH_ARGS+=("--dry-run")
            echo "üîç DRY RUN MODE: Would publish @hashgraph/asset-tokenization-sdk"
          fi

          npm publish "${PUBLISH_ARGS[@]}"

  # Summary job to report results
  summary:
    name: Publish Summary
    runs-on: token-studio-linux-large
    needs: [contracts, sdk]
    if: always()
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Report Results
        run: |
          echo "## ATS Publish Results" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Contracts | ${{ needs.contracts.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | ${{ needs.sdk.result }} |" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.dry-run-enabled }}" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üîç **DRY RUN MODE** - No packages were actually published" >> $GITHUB_STEP_SUMMARY
          fi
